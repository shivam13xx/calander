<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Floral Calendar 2026 - Dynamic</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600&family=Sacramento&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2"
      }
    }
    </script>

    <style>
      /* Custom scrollbar for modal */
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #fafaf9; }
      ::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #a8a29e; }
      
      @keyframes fade-in {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-fade-in {
        animation: fade-in 0.4s ease-out forwards;
      }
    </style>
  </head>
  <body class="bg-stone-50 text-stone-800">
    
    <div id="root" class="min-h-screen flex items-center justify-center text-stone-400">
      Loading Calendar...
    </div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useCallback } from 'react';
      import ReactDOM from 'react-dom/client';
      import { createClient } from '@supabase/supabase-js';

      // ==========================================
      // !!! üö® REPLACE THESE WITH YOUR KEYS üö® !!!
      // ==========================================
      const SUPABASE_URL = 'https://fiijbjuhbypsyqyqogxt.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpaWpianVoYnlwc3lxeXFvZ3h0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3NzA3NTMsImV4cCI6MjA4MTM0Njc1M30.MWW8oYg_3kZnPAp-gjY3mSAyqNFmOyDtZ5Pnicz-AcU';
      
      // Initialize Supabase
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // ==========================================
      // CONSTANTS
      // ==========================================
      const DAYS_OF_WEEK = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

      const MONTH_NAMES = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
      ];
      
      const FALLBACK_FLOWER_NAMES = [
        'Carnation', 'Violet', 'Daffodil', 'Daisy', 'Lily of the Valley', 
        'Rose', 'Larkspur', 'Gladiolus', 'Aster', 'Marigold', 'Chrysanthemum', 'Narcissus'
      ];

      const HISTORICAL_EVENTS = {
        '12-06': { title: 'Mahaparinirvan Diwas', description: 'Dr. B.R. Ambedkar breathed his last...', originalDate: 'December 6, 1956' },
        '04-14': { title: 'Janma Jayanti (Birth)', description: 'Bhimrao Ramji Ambedkar was born...', originalDate: 'April 14, 1891' },
        '03-20': { title: 'Mahad Satyagraha', description: 'Dr. Ambedkar led the Mahad Satyagraha...', originalDate: 'March 20, 1927' },
        '10-14': { title: 'Dhamma Chakra Pravartan', description: 'Dr. Ambedkar along with 600,000 followers embraced Buddhism...', originalDate: 'October 14, 1956' },
        '11-26': { title: 'Constitution Day', description: "The Constituent Assembly of India adopted the Constitution of India...", originalDate: 'November 26, 1949' }
      };

      // ==========================================
      // DATA SERVICES
      // ==========================================
      const fetchMonthlyData = async (monthNumber) => {
        try {
          const { data, error } = await supabase
            .from('monthly_details')
            .select('month_name, month_image_url')
            .eq('month_number', monthNumber)
            .single();

          if (error && error.code !== 'PGRST116') {
            console.error("Error fetching monthly data:", error);
            return null;
          }
          return data;
        } catch (err) {
          console.error("Supabase connection error (Monthly):", err);
          return null;
        }
      };

      const fetchDailyData = async (dateString) => {
        try {
          const { data, error } = await supabase
            .from('daily_entries')
            .select('short_title, daily_info, media_url, media_type')
            .eq('calendar_date', dateString)
            .single();

          if (error && error.code !== 'PGRST116') {
            console.error("Error fetching daily data:", error);
            return null;
          }
          return data;
        } catch (err) {
          console.error("Supabase connection error (Daily):", err);
          return null;
        }
      };

      // ==========================================
      // COMPONENTS
      // ==========================================

      // --- Calendar Component ---
      const Calendar = ({ 
        monthName, 
        year, 
        days, 
        onNext, 
        onPrev, 
        onDateClick,
        dynamicMonthData 
      }) => {

        const monthIndex = MONTH_NAMES.indexOf(monthName);
        const flowerName = dynamicMonthData.month_name || FALLBACK_FLOWER_NAMES[monthIndex];
        const monthlyImageUrl = dynamicMonthData.month_image_url;
        const [imgError, setImgError] = useState(false);

        useEffect(() => {
          setImgError(false);
        }, [monthlyImageUrl]);
        
        const getEvent = (day) => {
          const key = `${(monthIndex + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
          return HISTORICAL_EVENTS[key];
        };
        
        return (
          <div className="flex flex-col items-center w-full max-w-lg mx-auto p-8 bg-white min-h-[800px] shadow-2xl rounded-sm print:shadow-none print:w-full transition-all duration-500">
            
            {/* Artwork Section */}
            <div className="relative w-full h-64 flex justify-center items-center mb-4">
              {/* Blob Background */}
              <div 
                className="absolute w-48 h-48 bg-stone-100 rounded-full opacity-60 z-0 border border-stone-200"
                style={{
                  borderRadius: '60% 40% 30% 70% / 60% 30% 70% 40%',
                  transform: 'rotate(-5deg) translateY(5px)'
                }}
              />
              
              {/* Dynamic Monthly Image */}
              <div className="relative z-10 w-48 h-48 flex justify-center items-center overflow-hidden rounded-full border-4 border-white shadow-lg bg-stone-50">
                {monthlyImageUrl && !imgError ? (
                  <img 
                    src={monthlyImageUrl} 
                    alt={`${flowerName} art`} 
                    onError={() => setImgError(true)}
                    className="w-full h-full object-cover filter contrast-[0.9] sepia-[0.3] brightness-[1.05] saturate-[0.8]" 
                  />
                ) : (
                  <div className="flex flex-col items-center justify-center w-full h-full bg-stone-100 text-stone-400 p-4 text-center">
                    <span className="text-2xl mb-2 opacity-50">‚ùÄ</span>
                    <span className="text-sm font-serif italic text-stone-500">{flowerName}</span>
                  </div>
                )}
              </div>
              
              <div className="absolute z-20 w-[12.5rem] h-[12.5rem] rounded-full border border-stone-300 opacity-30 pointer-events-none" />
            </div>

            {/* Header Section */}
            <div className="text-center mb-10 w-full relative group">
              <button 
                onClick={onPrev}
                className="absolute left-0 top-1/2 -translate-y-1/2 p-2 text-stone-300 hover:text-stone-500 transition-colors print:hidden"
              >
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-8 h-8">
                  <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                </svg>
              </button>

              <button 
                onClick={onNext}
                className="absolute right-0 top-1/2 -translate-y-1/2 p-2 text-stone-300 hover:text-stone-500 transition-colors print:hidden"
              >
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-8 h-8">
                  <path strokeLinecap="round" strokeLinejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                </svg>
              </button>

              <h1 className="text-7xl mb-1 text-stone-800" style={{ fontFamily: '"Sacramento", cursive' }}>
                {monthName}
              </h1>
              <h2 className="text-3xl text-stone-500 tracking-[0.2em] font-light" style={{ fontFamily: '"Cormorant Garamond", serif' }}>
                {year}
              </h2>
            </div>

            {/* Grid Section */}
            <div className="w-full">
              <div className="grid grid-cols-7 mb-6 border-b border-stone-100 pb-2">
                {DAYS_OF_WEEK.map((day) => (
                  <div key={day} className="text-center text-sm uppercase tracking-widest text-stone-400 font-sans">
                    {day}
                  </div>
                ))}
              </div>

              <div className="grid grid-cols-7 gap-y-4 gap-x-1">
                {days.map((dayData, index) => {
                  if (!dayData) return <div key={`empty-${index}`} />;
                  
                  const event = getEvent(dayData.date);
                  return (
                    <button 
                      key={dayData.date} 
                      onClick={() => onDateClick(dayData.date)}
                      className={`flex flex-col items-center justify-start min-h-[3.5rem] relative text-stone-600 hover:text-stone-900 transition-all duration-300 cursor-pointer focus:outline-none group ${event ? 'text-blue-900' : ''}`}
                    >
                      <span className={`text-xl leading-none font-light relative z-10 ${event ? 'font-medium' : ''} group-hover:scale-110 transition-transform`} style={{ fontFamily: '"Cormorant Garamond", serif' }}>
                        {dayData.date}
                      </span>
                      {event ? (
                        <span className="mt-1 w-1 h-1 rounded-full bg-blue-800 opacity-60"></span>
                      ) : (
                        <span className="mt-1 w-1 h-1 rounded-full bg-stone-300 opacity-0 group-hover:opacity-100 transition-opacity"></span>
                      )}
                      {event && (
                        <span className="mt-1 text-[0.5rem] leading-none text-blue-800/70 font-sans uppercase tracking-wide text-center w-full px-0.5">
                          {event.title.split(' ')[0]}
                        </span>
                      )}
                    </button>
                  );
                })}
              </div>
            </div>
          </div>
        );
      };

      // --- DateDetailsModal Component ---
      const DateDetailsModal = ({
        isOpen,
        onClose,
        date,
        content,
        historicalEvent,
        loadingState
      }) => {
        if (!isOpen) return null;

        const formattedDate = date.toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });

        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div className="absolute inset-0 bg-stone-900/40 backdrop-blur-sm transition-opacity" onClick={onClose} />
            <div className="relative bg-white w-full max-w-lg p-8 rounded-sm shadow-2xl animate-fade-in flex flex-col items-center max-h-[90vh] overflow-y-auto">
              <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-800 transition-colors z-10">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6">
                  <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>

              <h2 className="text-4xl mb-2 text-center" style={{ fontFamily: '"Sacramento", cursive' }}>
                {formattedDate}
              </h2>
              
              {historicalEvent && (
                <div className="mb-6 w-full text-center border-b border-stone-200 pb-4">
                  <h3 className="text-2xl text-blue-900 mb-1 font-semibold" style={{ fontFamily: '"Cormorant Garamond", serif' }}>
                    {historicalEvent.title}
                  </h3>
                  <div className="text-xs text-stone-500 font-sans mb-3 tracking-widest uppercase">
                    {historicalEvent.originalDate}
                  </div>
                  <p className="text-stone-600 leading-relaxed font-sans text-sm">
                    {historicalEvent.description}
                  </p>
                </div>
              )}
              
              <div className="w-full aspect-square bg-stone-50 mb-6 flex items-center justify-center rounded-sm overflow-hidden border border-stone-100">
                {loadingState === 'LOADING' ? (
                  <div className="flex flex-col items-center gap-3">
                    <div className="w-8 h-8 border-2 border-stone-300 border-t-stone-600 rounded-full animate-spin"></div>
                    <span className="text-stone-400 font-serif italic">Loading custom content...</span>
                  </div>
                ) : content?.image && content?.mediaType?.startsWith('image') ? (
                  <img src={content.image} alt="Daily content" className="w-full h-full object-cover animate-fade-in" />
                ) : content?.image && content?.mediaType?.startsWith('video') ? (
                  <video controls src={content.image} className="w-full h-full object-cover animate-fade-in" />
                ) : (
                  <span className="text-stone-300 font-serif italic">No media uploaded.</span>
                )}
              </div>

              <div className="text-center min-h-[4rem] flex items-center justify-center">
                 {loadingState === 'LOADING' ? (
                   <span className="h-2 w-24 bg-stone-100 rounded animate-pulse"></span>
                 ) : content?.quote ? ( 
                   <p className="text-xl text-stone-700 leading-relaxed font-light italic whitespace-pre-wrap" style={{ fontFamily: '"Cormorant Garamond", serif' }}>
                     {content.quote}
                   </p>
                 ) : (
                    <p className="text-stone-400 font-serif italic">No description available.</p>
                 )}
              </div>
            </div>
          </div>
        );
      };

      // ==========================================
      // MAIN APP
      // ==========================================
      const App = () => {
        const [currentDate, setCurrentDate] = useState(new Date(2026, 0, 1));
        const [currentMonthData, setCurrentMonthData] = useState({
            month_name: MONTH_NAMES[0], 
            month_image_url: null
        });
        const [selectedDay, setSelectedDay] = useState(null);
        const [modalContent, setModalContent] = useState(null);
        const [modalHistoricalEvent, setModalHistoricalEvent] = useState(null);
        const [modalLoading, setModalLoading] = useState('IDLE');
        const [dailyCache, setDailyCache] = useState({});

        const year = currentDate.getFullYear();
        const monthIndex = currentDate.getMonth();
        const monthName = MONTH_NAMES[monthIndex];
        const monthNumber = monthIndex + 1;

        useEffect(() => {
            const loadMonth = async () => {
                const data = await fetchMonthlyData(monthNumber);
                const fallbackName = FALLBACK_FLOWER_NAMES[monthIndex];
                if (data) {
                    setCurrentMonthData({
                        month_name: data.month_name || fallbackName, 
                        month_image_url: data.month_image_url
                    });
                } else {
                    setCurrentMonthData({ month_name: fallbackName, month_image_url: null });
                }
            };
            loadMonth();
        }, [monthNumber, monthIndex]);

        const getCalendarDays = (date) => {
          const y = date.getFullYear();
          const m = date.getMonth();
          const firstDayOfWeek = new Date(y, m, 1).getDay();
          const daysInMonth = new Date(y, m + 1, 0).getDate();
          const days = [];
          for (let i = 0; i < firstDayOfWeek; i++) days.push(null);
          for (let d = 1; d <= daysInMonth; d++) days.push({ date: d });
          return days;
        };

        const days = getCalendarDays(currentDate);

        const handlePrev = useCallback(() => {
          setCurrentDate(prev => new Date(prev.getFullYear(), prev.getMonth() - 1, 1));
        }, []);

        const handleNext = useCallback(() => {
          setCurrentDate(prev => new Date(prev.getFullYear(), prev.getMonth() + 1, 1));
        }, []);

        const handleDateClick = async (day) => {
          setSelectedDay(day);
          const eventKey = `${(monthIndex + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
          const historicalEvent = HISTORICAL_EVENTS[eventKey] || null;
          setModalHistoricalEvent(historicalEvent);

          const dateString = `${year}-${(monthIndex + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
          
          if (dailyCache[dateString]) {
            setModalContent(dailyCache[dateString]);
            setModalLoading('SUCCESS');
            return;
          }

          setModalLoading('LOADING');
          setModalContent(null);

          const supabaseEntry = await fetchDailyData(dateString);
          let newContent;
          
          if (supabaseEntry) {
            newContent = { 
              title: supabaseEntry.short_title,
              quote: supabaseEntry.daily_info, 
              image: supabaseEntry.media_url,
              mediaType: supabaseEntry.media_type
            };
          } else {
            newContent = {
              title: 'No Content',
              quote: `No custom daily information uploaded for ${monthName} ${day}.`,
              image: null,
              mediaType: null
            };
          }

          setDailyCache(prev => ({ ...prev, [dateString]: newContent }));
          setModalContent(newContent);
          setModalLoading('SUCCESS');
        };

        const closeDateModal = () => {
          setSelectedDay(null);
          setModalContent(null);
          setModalHistoricalEvent(null);
        };

        const getFullSelectedDate = () => {
          if (!selectedDay) return new Date();
          return new Date(year, monthIndex, selectedDay);
        };

        return (
          <div className="min-h-screen bg-stone-50 py-10 px-4 flex flex-col items-center font-sans">
            <Calendar 
              monthName={monthName}
              year={year}
              days={days}
              dynamicMonthData={currentMonthData}
              onNext={handleNext}
              onPrev={handlePrev}
              onDateClick={handleDateClick}
            />

            <DateDetailsModal 
              isOpen={!!selectedDay}
              onClose={closeDateModal}
              date={getFullSelectedDate()}
              content={modalContent}
              historicalEvent={modalHistoricalEvent}
              loadingState={modalLoading}
            />

            <footer className="mt-8 text-stone-400 text-sm print:hidden text-center max-w-md">
              <p>Dynamic Content Powered by Supabase</p>
            </footer>
          </div>
        );
      };

      const rootElement = document.getElementById('root');
      if (rootElement) {
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);
      }
    </script>
  </body>
</html>
